# ğŸ“ Nome do workflow que aparecerÃ¡ no GitHub Actions
name: ğŸ§¹ Limpar ExecuÃ§Ãµes de Workflow Antigas

# â° Quando o workflow serÃ¡ executado
on:
  # ğŸ“… ExecuÃ§Ã£o agendada - uma vez por dia Ã s 02:00 UTC
  schedule:
    - cron: '1 0 1-31/2 * *'
  # ğŸ® Permite executar manualmente atravÃ©s da interface do GitHub
  workflow_dispatch:

# ğŸ—ï¸ DefiniÃ§Ã£o dos jobs (tarefas) a serem executados
jobs:
  # ğŸ§¼ Nome do job de limpeza
  cleanup:
    # ğŸ–¥ï¸ Ambiente de execuÃ§Ã£o (mÃ¡quina Ubuntu mais recente)
    runs-on: ubuntu-latest
    # ğŸ” PermissÃµes necessÃ¡rias para o job
    permissions:
      # ğŸš€ PermissÃ£o para escrever/gerenciar actions (necessÃ¡rio para deletar execuÃ§Ãµes)
      actions: write
    
    # ğŸ“‹ Lista de passos a serem executados sequencialmente
    steps:
      # ğŸ¯ Passo principal: deletar execuÃ§Ãµes de workflow antigas
      - name: ğŸ—‘ï¸ Deletar execuÃ§Ãµes de workflow antigas
        # ğŸŒ Define variÃ¡veis de ambiente para o passo
        env:
          # ğŸ”‘ Token de acesso automÃ¡tico do GitHub (permissÃµes jÃ¡ configuradas)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
        # ğŸ’» Comandos shell a serem executados
        run: |
          # ğŸ“¢ Mensagem inicial informando que a busca comeÃ§ou
          echo "ğŸ” Buscando execuÃ§Ãµes de workflow antigas..."

          # ğŸ“¥ PASSO 1: Buscar todas as execuÃ§Ãµes de workflow do repositÃ³rio
          # ğŸ› ï¸ Usando GitHub CLI (gh) para acessar API do GitHub
          # ğŸ“¡ Endpoint: /repos/{owner}/{repo}/actions/runs
          # ğŸ“Š --jq: Filtra e formata o JSON de resposta para pegar apenas id, created_at e status
          runs=$(gh api \
            -H "Accept: application/vnd.github.v3+json" \
            "/repos/${{ github.repository }}/actions/runs" \
            --jq '.workflow_runs[] | {id, created_at, status}')

          # â“ PASSO 2: Verificar se existem execuÃ§Ãµes para processar
          # ğŸ§ª Se a variÃ¡vel 'runs' estiver vazia, nÃ£o hÃ¡ nada para limpar
          if [ -z "$runs" ]; then
            # âœ… Mensagem de sucesso - nenhuma execuÃ§Ã£o encontrada
            echo "âœ… Nenhuma execuÃ§Ã£o de workflow encontrada."
            # ğŸšª Sai do script com sucesso
            exit 0
          fi

          # â° PASSO 3: Obter data e hora atual em formato timestamp Unix
          # ğŸ• Timestamp Ã© nÃºmero de segundos desde 1Âº de janeiro de 1970 (UTC)
          now=$(date -u +%s)

          # ğŸ”„ PASSO 4: Processar cada execuÃ§Ã£o de workflow encontrada
          # ğŸ“‹ Loop atravÃ©s de todas as execuÃ§Ãµes usando jq para processar JSON
          # ğŸ¯ -c: Processa cada objeto como JSON compacto
          # ğŸ“‹ select(.created_at != null): Filtra apenas execuÃ§Ãµes com data de criaÃ§Ã£o vÃ¡lida
          echo "$runs" | jq -c 'select(.created_at != null)' | while read -r run; do
            # ğŸ†” PASSO 4.1: Extrair ID da execuÃ§Ã£o de workflow
            id=$(echo "$run" | jq -r '.id')
            
            # ğŸ“… PASSO 4.2: Extrair data de criaÃ§Ã£o da execuÃ§Ã£o de workflow
            created_at=$(echo "$run" | jq -r '.created_at')

            # â³ PASSO 4.3: Converter data de criaÃ§Ã£o para timestamp Unix
            # ğŸ§ Compatibilidade Linux: tenta usar formato GNU date
            if date -u -d "$created_at" >/dev/null 2>&1; then
              run_date=$(date -u -d "$created_at" +%s)
            # ğŸ Compatibilidade macOS: tenta usar formato BSD date
            elif date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" >/dev/null 2>&1; then
              run_date=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" +%s)
            # âŒ Se nenhum formato funcionar, pula esta execuÃ§Ã£o
            else
              # âš ï¸ Mensagem de aviso para data invÃ¡lida
              echo "âš ï¸ NÃ£o foi possÃ­vel analisar a  $created_at"
              # ğŸ” Continua para a prÃ³xima execuÃ§Ã£o
              continue
            fi

            # ğŸ“Š PASSO 4.4: Calcular diferenÃ§a de tempo em dias
            # â±ï¸ Calcular diferenÃ§a em segundos entre agora e a criaÃ§Ã£o da execuÃ§Ã£o
            diff_seconds=$(( now - run_date ))
            # ğŸ“† Converter segundos para dias (86400 segundos = 24 horas = 1 dia)
            diff_days=$(( diff_seconds / 86400 ))

            # ğŸ§® PASSO 4.5: Verificar se a execuÃ§Ã£o tem mais de 2 dias
            if [ "$diff_days" -ge 2 ]; then
              # ğŸ—‘ï¸ PASSO 4.6: Deletar a execuÃ§Ã£o de workflow se tiver 2+ dias
              echo "ğŸ—‘ï¸ Deletando execuÃ§Ã£o de workflow ID: $id (Criada hÃ¡ $diff_days dias)"
              
              # ğŸš€ Chamada API para deletar a execuÃ§Ã£o de workflow especÃ­fica
              # ğŸ“ Endpoint: DELETE /repos/{owner}/{repo}/actions/runs/{run_id}
              # ğŸ¤« >/dev/null 2>&1: Suprime output normal e erros para manter log limpo
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github.v3+json" \
                "/repos/${{ github.repository }}/actions/runs/$id" \
                >/dev/null 2>&1 || echo "âš ï¸ Falha ao deletar execuÃ§Ã£o ID: $id"
            else
              # âœ… PASSO 4.7: Manter a execuÃ§Ã£o de workflow se tiver menos de 2 dias
              echo "âœ… ExecuÃ§Ã£o de workflow ID: $id ainda nÃ£o tem 2 dias (Criada hÃ¡ $diff_days dias)"
            fi
          done
          
          # ğŸ‰ PASSO 5: FinalizaÃ§Ã£o
          echo "ğŸ Processo de limpeza concluÃ­do!"
